# 系统化调试

## 何时激活

当你遇到需要调试的问题时，此技能会自动激活。问题可能表现为：

- 测试失败
- 程序崩溃
- 功能不符合预期
- 性能问题
- 任何需要找出根本原因的情况

## 目标

此技能的目标是使用系统化的四阶段过程来找出问题的根本原因：

1. **收集信息：** 收集足够的信息来理解问题
2. **形成假设：** 根据信息形成关于问题根本原因的假设
3. **验证假设：** 验证或否定每个假设
4. **解决问题：** 一旦找到根本原因，解决它

## 步骤

### 第一阶段：收集信息

在形成任何假设之前，收集尽可能多的信息：

1. **查看错误消息：** 仔细阅读错误消息和堆栈跟踪
2. **查看日志：** 检查相关日志文件
3. **查看代码：** 阅读相关代码以理解预期行为
4. **复现问题：** 尝试在可控环境中复现问题
5. **收集数据：** 收集足够的数据来理解问题的范围和影响

**提问示例：**

- 这个问题是什么时候开始的？
- 在这个问题出现之前，你做了什么更改？
- 这个问题的表现是什么？
- 这个问题在什么条件下会出现？
- 这个问题影响了多少用户/功能？

### 第二阶段：形成假设

基于收集到的信息，形成关于问题根本原因的假设：

1. **列出所有可能的原因：** 不要只考虑最明显的原因
2. **优先排序：** 根据可能性和影响对原因进行排序
3. **记录假设：** 记录每个假设以便后续验证

**提问示例：**

- 什么可能导致这个问题？
- 最近有什么更改可能引入这个问题？
- 这个问题与什么组件或模块相关？
- 这个问题是否与外部依赖相关？

### 第三阶段：验证假设

系统地验证每个假设：

1. **从最可能的假设开始：** 从概率最高的假设开始
2. **设计验证实验：** 设计一个能验证或否定假设的实验
3. **执行实验：** 执行实验并记录结果
4. **迭代：** 根据结果形成新的假设

**验证技术：**

- **添加日志：** 添加日志以跟踪代码执行路径
- **使用调试器：** 使用调试器逐步执行代码
- **编写测试：** 编写测试来验证特定行为
- **检查状态：** 检查变量和对象的状态
- **隔离问题：** 隔离问题的特定部分
- **对比分析：** 与正常工作的版本进行对比

**根因追踪技术：**

当直接验证很困难时，使用这些技术：

1. **时序分析：** 追踪事件发生的顺序
2. **依赖分析：** 追踪依赖关系和数据流
3. **状态分析：** 追踪系统状态的变化
4. **对比分析：** 对比正常和异常行为

### 第四阶段：解决问题

一旦找到根本原因，解决它：

1. **制定修复计划：** 制定一个最小化的修复计划
2. **实现修复：** 实现修复
3. **验证修复：** 验证修复解决了问题
4. **防止回归：** 添加测试以防止问题再次出现

## 防御性编程

在修复问题的同时，考虑如何防止类似问题再次出现：

1. **添加断言：** 添加断言来验证假设
2. **添加日志：** 添加日志以跟踪关键操作
3. **添加类型检查：** 添加类型检查来捕获类型错误
4. **添加边界检查：** 添加边界检查来捕获边界情况
5. **改进错误消息：** 改进错误消息以提供更多信息

## 基于条件的等待

当等待某些条件时：

1. **设置超时：** 设置最大等待时间
2. **轮询检查：** 定期检查条件是否满足
3. **使用事件：** 如果可能，使用事件而不是轮询
4. **记录等待：** 记录等待尝试以便于调试

## 常见错误

### 只看症状

不要只治疗症状。要找出根本原因并治疗根本原因。

### 跳过步骤

不要跳过任何步骤。每个步骤都很重要。

### 形成偏见

不要形成关于根本原因的偏见。让数据引导你。

### 过度工程

不要过度工程。只修复直接问题。

### 忽略测试

不要忽略测试。添加测试以验证修复。

## 示例

### 不好

> **问题：** 测试失败
> 
> **不好方法：**
> - 立即修改代码
> - 不理解为什么测试失败
> - 不添加新测试

### 好

> **问题：** 测试失败
> 
> **好方法：**
> 
> **第一阶段：收集信息**
> - 运行测试并查看错误消息
> - 查看相关代码
> - 理解测试的预期行为
> 
> **第二阶段：形成假设**
> - 假设函数返回错误值
> - 假设测试的预期值错误
> - 假设依赖组件的行为改变
> 
> **第三阶段：验证假设**
> - 添加日志来查看函数返回值
> - 验证测试的预期值
> - 检查依赖组件的变化
> 
> **第四阶段：解决问题**
> - 修复代码中的错误
> - 添加新测试以覆盖这个情况
> - 运行所有测试以确保没有回归

## 验证完成

在宣布问题已解决之前：

1. **运行测试：** 运行相关测试以验证修复
2. **手动测试：** 手动测试相关功能
3. **检查日志：** 检查日志中没有新的错误
4. **检查监控：** 如果适用，检查监控系统
5. **询问用户：** 如果适用，询问用户问题是否解决
